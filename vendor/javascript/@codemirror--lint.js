import{Decoration as e,EditorView as t,hoverTooltip as i,showPanel as n,getPanel as o,ViewPlugin as s,logException as r,WidgetType as a,GutterMarker as l,gutter as c,showTooltip as d}from"@codemirror/view";import{StateEffect as m,StateField as u,Facet as f,combineConfig as h,RangeSet as g}from"@codemirror/state";import p from"crelt";class SelectedDiagnostic{constructor(e,t,i){this.from=e;this.to=t;this.diagnostic=i}}class LintState{constructor(e,t,i){this.diagnostics=e;this.panel=t;this.selected=i}static init(t,i,n){let o=t;let s=n.facet(L).markerFilter;s&&(o=s(o));let r=e.set(o.map((t=>t.from==t.to||t.from==t.to-1&&n.doc.lineAt(t.from).to==t.from?e.widget({widget:new DiagnosticWidget(t),diagnostic:t}).range(t.from):e.mark({attributes:{class:"cm-lintRange cm-lintRange-"+t.severity},diagnostic:t}).range(t.from,t.to))),true);return new LintState(r,i,findDiagnostic(r))}}function findDiagnostic(e,t=null,i=0){let n=null;e.between(i,1e9,((e,i,{spec:o})=>{if(!t||o.diagnostic==t){n=new SelectedDiagnostic(e,i,o.diagnostic);return false}}));return n}function hideTooltip(e,t){return!!(e.effects.some((e=>e.is(v)))||e.changes.touchesRange(t.pos))}function maybeEnableLint(n,o){return n.field(k,false)?o:o.concat(m.appendConfig.of([k,t.decorations.compute([k],(t=>{let{selected:i,panel:n}=t.field(k);return i&&n&&i.from!=i.to?e.set([y.range(i.from,i.to)]):e.none})),i(lintTooltip,{hideOn:hideTooltip}),T]))}function setDiagnostics(e,t){return{effects:maybeEnableLint(e,[v.of(t)])}}const v=m.define();const w=m.define();const b=m.define();const k=u.define({create(){return new LintState(e.none,null,null)},update(e,t){if(t.docChanged){let i=e.diagnostics.map(t.changes),n=null;if(e.selected){let o=t.changes.mapPos(e.selected.from,1);n=findDiagnostic(i,e.selected.diagnostic,o)||findDiagnostic(i,null,o)}e=new LintState(i,e.panel,n)}for(let i of t.effects)i.is(v)?e=LintState.init(i.value,e.panel,t.state):i.is(w)?e=new LintState(e.diagnostics,i.value?LintPanel.open:null,e.selected):i.is(b)&&(e=new LintState(e.diagnostics,e.panel,i.value));return e},provide:e=>[n.from(e,(e=>e.panel)),t.decorations.from(e,(e=>e.diagnostics))]});function diagnosticCount(e){let t=e.field(k,false);return t?t.diagnostics.size:0}const y=e.mark({class:"cm-lintRange cm-lintRange-active"});function lintTooltip(e,t,i){let{diagnostics:n}=e.state.field(k);let o=[],s=2e8,r=0;n.between(t-(i<0?1:0),t+(i>0?1:0),((e,n,{spec:a})=>{if(t>=e&&t<=n&&(e==n||(t>e||i>0)&&(t<n||i<0))){o.push(a.diagnostic);s=Math.min(e,s);r=Math.max(n,r)}}));let a=e.state.facet(L).tooltipFilter;a&&(o=a(o));return o.length?{pos:s,end:r,above:e.state.doc.lineAt(s).to<r,create(){return{dom:diagnosticsTooltip(e,o)}}}:null}function diagnosticsTooltip(e,t){return p("ul",{class:"cm-tooltip-lint"},t.map((t=>renderDiagnostic(e,t,false))))}const openLintPanel=e=>{let t=e.state.field(k,false);t&&t.panel||e.dispatch({effects:maybeEnableLint(e.state,[w.of(true)])});let i=o(e,LintPanel.open);i&&i.dom.querySelector(".cm-panel-lint ul").focus();return true};const closeLintPanel=e=>{let t=e.state.field(k,false);if(!t||!t.panel)return false;e.dispatch({effects:w.of(false)});return true};const nextDiagnostic=e=>{let t=e.state.field(k,false);if(!t)return false;let i=e.state.selection.main,n=t.diagnostics.iter(i.to+1);if(!n.value){n=t.diagnostics.iter(0);if(!n.value||n.from==i.from&&n.to==i.to)return false}e.dispatch({selection:{anchor:n.from,head:n.to},scrollIntoView:true});return true};const x=[{key:"Mod-Shift-m",run:openLintPanel},{key:"F8",run:nextDiagnostic}];const C=s.fromClass(class{constructor(e){this.view=e;this.timeout=-1;this.set=true;let{delay:t}=e.state.facet(L);this.lintTime=Date.now()+t;this.run=this.run.bind(this);this.timeout=setTimeout(this.run,t)}run(){let e=Date.now();if(e<this.lintTime-10)setTimeout(this.run,this.lintTime-e);else{this.set=false;let{state:e}=this.view,{sources:t}=e.facet(L);Promise.all(t.map((e=>Promise.resolve(e(this.view))))).then((t=>{let i=t.reduce(((e,t)=>e.concat(t)));this.view.state.doc==e.doc&&this.view.dispatch(setDiagnostics(this.view.state,i))}),(e=>{r(this.view.state,e)}))}}update(e){let t=e.state.facet(L);if(e.docChanged||t!=e.startState.facet(L)){this.lintTime=Date.now()+t.delay;if(!this.set){this.set=true;this.timeout=setTimeout(this.run,t.delay)}}}force(){if(this.set){this.lintTime=Date.now();this.run()}}destroy(){clearTimeout(this.timeout)}});const L=f.define({combine(e){return Object.assign({sources:e.map((e=>e.source))},h(e.map((e=>e.config)),{delay:750,markerFilter:null,tooltipFilter:null}))},enables:C});function linter(e,t={}){return L.of({source:e,config:t})}function forceLinting(e){let t=e.plugin(C);t&&t.force()}function assignKeys(e){let t=[];if(e)e:for(let{name:i}of e){for(let e=0;e<i.length;e++){let n=i[e];if(/[a-zA-Z]/.test(n)&&!t.some((e=>e.toLowerCase()==n.toLowerCase()))){t.push(n);continue e}}t.push("")}return t}function renderDiagnostic(e,t,i){var n;let o=i?assignKeys(t.actions):[];return p("li",{class:"cm-diagnostic cm-diagnostic-"+t.severity},p("span",{class:"cm-diagnosticText"},t.renderMessage?t.renderMessage():t.message),null===(n=t.actions)||void 0===n?void 0:n.map(((i,n)=>{let click=n=>{n.preventDefault();let o=findDiagnostic(e.state.field(k).diagnostics,t);o&&i.apply(e,o.from,o.to)};let{name:s}=i,r=o[n]?s.indexOf(o[n]):-1;let a=r<0?s:[s.slice(0,r),p("u",s.slice(r,r+1)),s.slice(r+1)];return p("button",{type:"button",class:"cm-diagnosticAction",onclick:click,onmousedown:click,"aria-label":` Action: ${s}${r<0?"":` (access key "${o[n]})"`}.`},a)})),t.source&&p("div",{class:"cm-diagnosticSource"},t.source))}class DiagnosticWidget extends a{constructor(e){super();this.diagnostic=e}eq(e){return e.diagnostic==this.diagnostic}toDOM(){return p("span",{class:"cm-lintPoint cm-lintPoint-"+this.diagnostic.severity})}}class PanelItem{constructor(e,t){this.diagnostic=t;this.id="item_"+Math.floor(4294967295*Math.random()).toString(16);this.dom=renderDiagnostic(e,t,true);this.dom.id=this.id;this.dom.setAttribute("role","option")}}class LintPanel{constructor(e){this.view=e;this.items=[];let onkeydown=t=>{if(27==t.keyCode){closeLintPanel(this.view);this.view.focus()}else if(38==t.keyCode||33==t.keyCode)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(40==t.keyCode||34==t.keyCode)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(36==t.keyCode)this.moveSelection(0);else if(35==t.keyCode)this.moveSelection(this.items.length-1);else if(13==t.keyCode)this.view.focus();else{if(!(t.keyCode>=65&&t.keyCode<=90&&this.selectedIndex>=0))return;{let{diagnostic:i}=this.items[this.selectedIndex],n=assignKeys(i.actions);for(let o=0;o<n.length;o++)if(n[o].toUpperCase().charCodeAt(0)==t.keyCode){let t=findDiagnostic(this.view.state.field(k).diagnostics,i);t&&i.actions[o].apply(e,t.from,t.to)}}}t.preventDefault()};let onclick=e=>{for(let t=0;t<this.items.length;t++)this.items[t].dom.contains(e.target)&&this.moveSelection(t)};this.list=p("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:onkeydown,onclick:onclick});this.dom=p("div",{class:"cm-panel-lint"},this.list,p("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>closeLintPanel(this.view)},"Ã—"));this.update()}get selectedIndex(){let e=this.view.state.field(k).selected;if(!e)return-1;for(let t=0;t<this.items.length;t++)if(this.items[t].diagnostic==e.diagnostic)return t;return-1}update(){let{diagnostics:e,selected:t}=this.view.state.field(k);let i=0,n=false,o=null;e.between(0,this.view.state.doc.length,((e,s,{spec:r})=>{let a,l=-1;for(let e=i;e<this.items.length;e++)if(this.items[e].diagnostic==r.diagnostic){l=e;break}if(l<0){a=new PanelItem(this.view,r.diagnostic);this.items.splice(i,0,a);n=true}else{a=this.items[l];if(l>i){this.items.splice(i,l-i);n=true}}if(t&&a.diagnostic==t.diagnostic){if(!a.dom.hasAttribute("aria-selected")){a.dom.setAttribute("aria-selected","true");o=a}}else a.dom.hasAttribute("aria-selected")&&a.dom.removeAttribute("aria-selected");i++}));while(i<this.items.length&&!(1==this.items.length&&this.items[0].diagnostic.from<0)){n=true;this.items.pop()}if(0==this.items.length){this.items.push(new PanelItem(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")}));n=true}if(o){this.list.setAttribute("aria-activedescendant",o.id);this.view.requestMeasure({key:this,read:()=>({sel:o.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:e,panel:t})=>{e.top<t.top?this.list.scrollTop-=t.top-e.top:e.bottom>t.bottom&&(this.list.scrollTop+=e.bottom-t.bottom)}})}else this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant");n&&this.sync()}sync(){let e=this.list.firstChild;function rm(){let t=e;e=t.nextSibling;t.remove()}for(let t of this.items)if(t.dom.parentNode==this.list){while(e!=t.dom)rm();e=t.dom.nextSibling}else this.list.insertBefore(t.dom,e);while(e)rm()}moveSelection(e){if(this.selectedIndex<0)return;let t=this.view.state.field(k);let i=findDiagnostic(t.diagnostics,this.items[e].diagnostic);i&&this.view.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:true,effects:b.of(i)})}static open(e){return new LintPanel(e)}}function svg(e,t='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${t}>${encodeURIComponent(e)}</svg>')`}function underline(e){return svg(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${e}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const T=t.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:underline("#d11")},".cm-lintRange-warning":{backgroundImage:underline("orange")},".cm-lintRange-info":{backgroundImage:underline("#999")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});class LintGutterMarker extends l{constructor(e){super();this.diagnostics=e;this.severity=e.reduce(((e,t)=>{let i=t.severity;return"error"==i||"warning"==i&&"info"==e?i:e}),"info")}toDOM(e){let t=document.createElement("div");t.className="cm-lint-marker cm-lint-marker-"+this.severity;let i=this.diagnostics;let n=e.state.facet(A).tooltipFilter;n&&(i=n(i));i.length&&(t.onmouseover=()=>gutterMarkerMouseOver(e,t,i));return t}}function trackHoverOn(e,t){let mousemove=i=>{let n=t.getBoundingClientRect();if(!(i.clientX>n.left-10&&i.clientX<n.right+10&&i.clientY>n.top-10&&i.clientY<n.bottom+10)){for(let e=i.target;e;e=e.parentNode)if(1==e.nodeType&&e.classList.contains("cm-tooltip-lint"))return;window.removeEventListener("mousemove",mousemove);e.state.field(M)&&e.dispatch({effects:R.of(null)})}};window.addEventListener("mousemove",mousemove)}function gutterMarkerMouseOver(e,t,i){function hovered(){let n=e.elementAtHeight(t.getBoundingClientRect().top+5-e.documentTop);const o=e.coordsAtPos(n.from);o&&e.dispatch({effects:R.of({pos:n.from,above:false,create(){return{dom:diagnosticsTooltip(e,i),getCoords:()=>t.getBoundingClientRect()}}})});t.onmouseout=t.onmousemove=null;trackHoverOn(e,t)}let{hoverTime:n}=e.state.facet(A);let o=setTimeout(hovered,n);t.onmouseout=()=>{clearTimeout(o);t.onmouseout=t.onmousemove=null};t.onmousemove=()=>{clearTimeout(o);o=setTimeout(hovered,n)}}function markersForDiagnostics(e,t){let i=Object.create(null);for(let n of t){let t=e.lineAt(n.from);(i[t.from]||(i[t.from]=[])).push(n)}let n=[];for(let e in i)n.push(new LintGutterMarker(i[e]).range(+e));return g.of(n,true)}const D=c({class:"cm-gutter-lint",markers:e=>e.state.field(S)});const S=u.define({create(){return g.empty},update(e,t){e=e.map(t.changes);let i=t.state.facet(A).markerFilter;for(let n of t.effects)if(n.is(v)){let o=n.value;i&&(o=i(o||[]));e=markersForDiagnostics(t.state.doc,o.slice(0))}return e}});const R=m.define();const M=u.define({create(){return null},update(e,t){e&&t.docChanged&&(e=hideTooltip(t,e)?null:Object.assign(Object.assign({},e),{pos:t.changes.mapPos(e.pos)}));return t.effects.reduce(((e,t)=>t.is(R)?t.value:e),e)},provide:e=>d.from(e)});const P=t.baseTheme({".cm-gutter-lint":{width:"1.4em","& .cm-gutterElement":{padding:".2em"}},".cm-lint-marker":{width:"1em",height:"1em"},".cm-lint-marker-info":{content:svg('<path fill="#aaf" stroke="#77e" stroke-width="6" stroke-linejoin="round" d="M5 5L35 5L35 35L5 35Z"/>')},".cm-lint-marker-warning":{content:svg('<path fill="#fe8" stroke="#fd7" stroke-width="6" stroke-linejoin="round" d="M20 6L37 35L3 35Z"/>')},".cm-lint-marker-error:before":{content:svg('<circle cx="20" cy="20" r="15" fill="#f87" stroke="#f43" stroke-width="6"/>')}});const A=f.define({combine(e){return h(e,{hoverTime:300,markerFilter:null,tooltipFilter:null})}});function lintGutter(e={}){return[A.of(e),S,D,P,M]}export{closeLintPanel,diagnosticCount,forceLinting,lintGutter,x as lintKeymap,linter,nextDiagnostic,openLintPanel,setDiagnostics,v as setDiagnosticsEffect};

