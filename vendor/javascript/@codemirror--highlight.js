import{NodeProp as t,NodeType as e}from"@lezer/common";import{StyleModule as a}from"style-mod";import{EditorView as i,Decoration as r,ViewPlugin as l}from"@codemirror/view";import{Facet as o,Prec as s}from"@codemirror/state";import{syntaxTree as n}from"@codemirror/language";import{RangeSetBuilder as c}from"@codemirror/rangeset";let h=0;class Tag{constructor(t,e,a){this.set=t;this.base=e;this.modified=a;this.id=h++}static define(t){if(null===t||void 0===t?void 0:t.base)throw new Error("Can not derive from a modified tag");let e=new Tag([],null,[]);e.set.push(e);if(t)for(let a of t.set)e.set.push(a);return e}static defineModifier(){let t=new Modifier;return e=>e.modified.indexOf(t)>-1?e:Modifier.get(e.base||e,e.modified.concat(t).sort(((t,e)=>t.id-e.id)))}}let g=0;class Modifier{constructor(){this.instances=[];this.id=g++}static get(t,e){if(!e.length)return t;let a=e[0].instances.find((a=>a.base==t&&sameArray(e,a.modified)));if(a)return a;let i=[],r=new Tag(i,t,e);for(let t of e)t.instances.push(r);let l=permute(e);for(let e of t.set)for(let t of l)i.push(Modifier.get(e,t));return r}}function sameArray(t,e){return t.length==e.length&&t.every(((t,a)=>t==e[a]))}function permute(t){let e=[t];for(let a=0;a<t.length;a++)for(let i of permute(t.slice(0,a).concat(t.slice(a+1))))e.push(i);return e}function styleTags(t){let e=Object.create(null);for(let a in t){let i=t[a];Array.isArray(i)||(i=[i]);for(let t of a.split(" "))if(t){let a=[],r=2,l=t;for(let e=0;;){if("..."==l&&e>0&&e+3==t.length){r=1;break}let i=/^"(?:[^"\\]|\\.)*?"|[^\/!]+/.exec(l);if(!i)throw new RangeError("Invalid path: "+t);a.push("*"==i[0]?null:'"'==i[0][0]?JSON.parse(i[0]):i[0]);e+=i[0].length;if(e==t.length)break;let o=t[e++];if(e==t.length&&"!"==o){r=0;break}if("/"!=o)throw new RangeError("Invalid path: "+t);l=t.slice(e)}let o=a.length-1,s=a[o];if(!s)throw new RangeError("Invalid path: "+t);let n=new Rule(i,r,o>0?a.slice(0,o):null);e[s]=n.sort(e[s])}}return m.add(e)}const m=new t;const d=o.define({combine(t){return t.length?HighlightStyle.combinedMatch(t):null}});const f=o.define({combine(t){return t.length?t[0].match:null}});function getHighlightStyle(t){return t.facet(d)||t.facet(f)}class Rule{constructor(t,e,a,i){this.tags=t;this.mode=e;this.context=a;this.next=i}sort(t){if(!t||t.depth<this.depth){this.next=t;return this}t.next=this.sort(t.next);return t}get depth(){return this.context?this.context.length:0}}class HighlightStyle{constructor(t,e){this.map=Object.create(null);let r;function def(t){let e=a.newName();(r||(r=Object.create(null)))["."+e]=t;return e}this.all="string"==typeof e.all?e.all:e.all?def(e.all):null;for(let e of t){let t=(e.class||def(Object.assign({},e,{tag:null})))+(this.all?" "+this.all:"");let a=e.tag;if(Array.isArray(a))for(let e of a)this.map[e.id]=t;else this.map[a.id]=t}this.module=r?new a(r):null;this.scope=e.scope||null;this.match=this.match.bind(this);let l=[u];this.module&&l.push(i.styleModule.of(this.module));this.extension=l.concat(null==e.themeType?d.of(this):d.computeN([i.darkTheme],(t=>t.facet(i.darkTheme)==("dark"==e.themeType)?[this]:[])));this.fallback=l.concat(f.of(this))}match(t,e){if(this.scope&&e!=this.scope)return null;for(let e of t.set){let a=this.map[e.id];if(void 0!==a){e!=t&&(this.map[t.id]=a);return a}}return this.map[t.id]=this.all}static combinedMatch(t){if(1==t.length)return t[0].match;let e=t.some((t=>t.scope))?void 0:Object.create(null);return(a,i)=>{let r=e&&e[a.id];if(void 0!==r)return r;let l=null;for(let e of t){let t=e.match(a,i);t&&(l=l?l+" "+t:t)}e&&(e[a.id]=l);return l}}static define(t,e){return new HighlightStyle(t,e||{})}static get(t,a,i){let r=getHighlightStyle(t);return r&&r(a,i||e.none)}}function highlightTree(t,e,a,i=0,r=t.length){highlightTreeRange(t,i,r,e,a)}class TreeHighlighter{constructor(t){this.markCache=Object.create(null);this.tree=n(t.state);this.decorations=this.buildDeco(t,getHighlightStyle(t.state))}update(t){let e=n(t.state),a=getHighlightStyle(t.state);let i=a!=t.startState.facet(d);if(e.length<t.view.viewport.to&&!i&&e.type==this.tree.type)this.decorations=this.decorations.map(t.changes);else if(e!=this.tree||t.viewportChanged||i){this.tree=e;this.decorations=this.buildDeco(t.view,a)}}buildDeco(t,e){if(!e||!this.tree.length)return r.none;let a=new c;for(let{from:i,to:l}of t.visibleRanges)highlightTreeRange(this.tree,i,l,e,((t,e,i)=>{a.add(t,e,this.markCache[i]||(this.markCache[i]=r.mark({class:i})))}));return a.finish()}}const u=s.high(l.fromClass(TreeHighlighter,{decorations:t=>t.decorations}));const p=[""];class HighlightBuilder{constructor(t,e,a){this.at=t;this.style=e;this.span=a;this.class=""}startSpan(t,e){if(e!=this.class){this.flush(t);t>this.at&&(this.at=t);this.class=e}}flush(t){t>this.at&&this.class&&this.span(this.at,t,this.class)}highlightRange(e,a,i,r,l,o){let{type:s,from:n,to:c}=e;if(n>=i||c<=a)return;p[l]=s.name;s.isTop&&(o=s);let h=r;let g=s.prop(m),d=false;while(g){if(!g.context||matchContext(g.context,p,l)){for(let t of g.tags){let e=this.style(t,o);if(e){h&&(h+=" ");h+=e;1==g.mode?r+=(r?" ":"")+e:0==g.mode&&(d=true)}}break}g=g.next}this.startSpan(e.from,h);if(d)return;let f=e.tree&&e.tree.prop(t.mounted);if(f&&f.overlay){let t=e.node.enter(f.overlay[0].from+n,1);let s=e.firstChild();for(let g=0,m=n;;g++){let d=g<f.overlay.length?f.overlay[g]:null;let u=d?d.from+n:c;let p=Math.max(a,m),b=Math.min(i,u);if(p<b&&s)while(e.from<b){this.highlightRange(e,p,b,r,l+1,o);this.startSpan(Math.min(i,e.to),h);if(e.to>=u||!e.nextSibling())break}if(!d||u>i)break;m=d.to+n;if(m>a){this.highlightRange(t.cursor,Math.max(a,d.from+n),Math.min(i,m),r,l,f.tree.type);this.startSpan(m,h)}}s&&e.parent()}else if(e.firstChild()){do{if(!(e.to<=a)){if(e.from>=i)break;this.highlightRange(e,a,i,r,l+1,o);this.startSpan(Math.min(i,e.to),h)}}while(e.nextSibling());e.parent()}}}function highlightTreeRange(t,e,a,i,r){let l=new HighlightBuilder(e,i,r);l.highlightRange(t.cursor(),e,a,"",0,t.type);l.flush(a)}function matchContext(t,e,a){if(t.length>a-1)return false;for(let i=a-1,r=t.length-1;r>=0;r--,i--){let a=t[r];if(a&&a!=e[i])return false}return true}const b=Tag.define;const y=b(),N=b(),v=b(N),w=b(N),k=b(),x=b(k),T=b(k),S=b(),M=b(S),O=b(),H=b(),R=b(),C=b(R),j=b();const A={comment:y,lineComment:b(y),blockComment:b(y),docComment:b(y),name:N,variableName:b(N),typeName:v,tagName:b(v),propertyName:w,attributeName:b(w),className:b(N),labelName:b(N),namespace:b(N),macroName:b(N),literal:k,string:x,docString:b(x),character:b(x),attributeValue:b(x),number:T,integer:b(T),float:b(T),bool:b(k),regexp:b(k),escape:b(k),color:b(k),url:b(k),keyword:O,self:b(O),null:b(O),atom:b(O),unit:b(O),modifier:b(O),operatorKeyword:b(O),controlKeyword:b(O),definitionKeyword:b(O),moduleKeyword:b(O),operator:H,derefOperator:b(H),arithmeticOperator:b(H),logicOperator:b(H),bitwiseOperator:b(H),compareOperator:b(H),updateOperator:b(H),definitionOperator:b(H),typeOperator:b(H),controlOperator:b(H),punctuation:R,separator:b(R),bracket:C,angleBracket:b(C),squareBracket:b(C),paren:b(C),brace:b(C),content:S,heading:M,heading1:b(M),heading2:b(M),heading3:b(M),heading4:b(M),heading5:b(M),heading6:b(M),contentSeparator:b(S),list:b(S),quote:b(S),emphasis:b(S),strong:b(S),link:b(S),monospace:b(S),strikethrough:b(S),inserted:b(),deleted:b(),changed:b(),invalid:b(),meta:j,documentMeta:b(j),annotation:b(j),processingInstruction:b(j),definition:Tag.defineModifier(),constant:Tag.defineModifier(),function:Tag.defineModifier(),standard:Tag.defineModifier(),local:Tag.defineModifier(),special:Tag.defineModifier()};const D=HighlightStyle.define([{tag:A.link,textDecoration:"underline"},{tag:A.heading,textDecoration:"underline",fontWeight:"bold"},{tag:A.emphasis,fontStyle:"italic"},{tag:A.strong,fontWeight:"bold"},{tag:A.strikethrough,textDecoration:"line-through"},{tag:A.keyword,color:"#708"},{tag:[A.atom,A.bool,A.url,A.contentSeparator,A.labelName],color:"#219"},{tag:[A.literal,A.inserted],color:"#164"},{tag:[A.string,A.deleted],color:"#a11"},{tag:[A.regexp,A.escape,A.special(A.string)],color:"#e40"},{tag:A.definition(A.variableName),color:"#00f"},{tag:A.local(A.variableName),color:"#30a"},{tag:[A.typeName,A.namespace],color:"#085"},{tag:A.className,color:"#167"},{tag:[A.special(A.variableName),A.macroName],color:"#256"},{tag:A.definition(A.propertyName),color:"#00c"},{tag:A.comment,color:"#940"},{tag:A.meta,color:"#7a757a"},{tag:A.invalid,color:"#f00"}]);const B=HighlightStyle.define([{tag:A.link,class:"cmt-link"},{tag:A.heading,class:"cmt-heading"},{tag:A.emphasis,class:"cmt-emphasis"},{tag:A.strong,class:"cmt-strong"},{tag:A.keyword,class:"cmt-keyword"},{tag:A.atom,class:"cmt-atom"},{tag:A.bool,class:"cmt-bool"},{tag:A.url,class:"cmt-url"},{tag:A.labelName,class:"cmt-labelName"},{tag:A.inserted,class:"cmt-inserted"},{tag:A.deleted,class:"cmt-deleted"},{tag:A.literal,class:"cmt-literal"},{tag:A.string,class:"cmt-string"},{tag:A.number,class:"cmt-number"},{tag:[A.regexp,A.escape,A.special(A.string)],class:"cmt-string2"},{tag:A.variableName,class:"cmt-variableName"},{tag:A.local(A.variableName),class:"cmt-variableName cmt-local"},{tag:A.definition(A.variableName),class:"cmt-variableName cmt-definition"},{tag:A.special(A.variableName),class:"cmt-variableName2"},{tag:A.definition(A.propertyName),class:"cmt-propertyName cmt-definition"},{tag:A.typeName,class:"cmt-typeName"},{tag:A.namespace,class:"cmt-namespace"},{tag:A.className,class:"cmt-className"},{tag:A.macroName,class:"cmt-macroName"},{tag:A.propertyName,class:"cmt-propertyName"},{tag:A.operator,class:"cmt-operator"},{tag:A.comment,class:"cmt-comment"},{tag:A.meta,class:"cmt-meta"},{tag:A.invalid,class:"cmt-invalid"},{tag:A.punctuation,class:"cmt-punctuation"}]);export{HighlightStyle,Tag,B as classHighlightStyle,D as defaultHighlightStyle,highlightTree,styleTags,A as tags};

